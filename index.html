<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Day Planner</title>
<style>
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  position: relative;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
}

/* Galaxy — Orion Nebula */
body[data-theme="galaxy"]::before {
  background-image:
    linear-gradient(to bottom, rgba(11,13,26,0.5), rgba(11,13,26,0.75)),
    url('https://images.unsplash.com/photo-1741016825495-1faf2afc19d6?w=1920&q=80');
  background-size: cover;
  background-position: center;
}

/* Dune — orange-hazed Arrakis desert under burning sky */
body[data-theme="dune"]::before {
  background-image:
    linear-gradient(to bottom, rgba(26,21,16,0.45), rgba(26,21,16,0.8)),
    url('https://images.unsplash.com/photo-1517263363407-f3ec9b44b64b?w=1920&q=80');
  background-size: cover;
  background-position: center;
}

/* Blade Runner — rain-soaked neon city street at night */
body[data-theme="blade-runner"]::before {
  background-image:
    linear-gradient(to bottom, rgba(10,10,18,0.45), rgba(10,10,18,0.8)),
    url('https://images.unsplash.com/photo-1644919070369-c0d17244fd88?w=1920&q=80');
  background-size: cover;
  background-position: center;
}

/* Tron — dark sci-fi neon tunnel into the Grid */
body[data-theme="tron"]::before {
  background-image:
    linear-gradient(to bottom, rgba(5,5,16,0.5), rgba(5,5,16,0.8)),
    url('https://images.unsplash.com/photo-1578902592469-890ca26340c7?w=1920&q=80');
  background-size: cover;
  background-position: center;
}

.container {
  max-width: 720px;
  margin: 0 auto;
  padding: 24px 16px;
}

/* Header */
.header {
  text-align: center;
  margin-bottom: 24px;
}

.header h1 {
  font-size: 1.5rem;
  color: var(--accent);
  margin-bottom: 16px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.nav button {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 16px;
  font-size: 0.9rem;
  cursor: pointer;
  color: var(--text);
  transition: background 0.15s, border-color 0.15s;
}

.nav button:hover {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.nav .arrow-btn {
  padding: 8px 12px;
  font-size: 1.1rem;
  font-weight: 700;
}

.date-display {
  font-size: 1.05rem;
  font-weight: 600;
  min-width: 180px;
  text-align: center;
}

/* Info bar (market + weather) */
.info-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  justify-content: center;
  flex-wrap: wrap;
  align-items: stretch;
}

.ticker-tile {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 8px 14px;
  border-radius: 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  min-width: 72px;
}

.ticker-name {
  font-size: 0.65rem;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.ticker-pct {
  font-size: 0.95rem;
  font-weight: 700;
  margin-top: 2px;
}

.ticker-pct.positive { color: var(--card-green); }
.ticker-pct.negative { color: var(--card-red); }
.ticker-pct.neutral  { color: var(--muted); }

.weather-tile {
  display: flex;
  flex-direction: column;
  padding: 8px 14px;
  border-radius: 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  min-width: 200px;
  gap: 4px;
}

.weather-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 8px;
}

.weather-loc {
  font-size: 0.6rem;
  color: var(--muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.weather-main {
  display: flex;
  align-items: baseline;
  gap: 6px;
}

.weather-temp {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
}

.weather-feels {
  font-size: 0.6rem;
  color: var(--muted);
}

.weather-desc {
  font-size: 0.65rem;
  color: var(--muted);
}

.weather-details {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.weather-detail {
  font-size: 0.6rem;
  color: var(--muted);
}

.weather-detail b {
  color: var(--text);
  font-weight: 600;
}

.weather-forecast {
  font-size: 0.6rem;
  color: var(--muted);
  border-top: 1px solid var(--border);
  padding-top: 3px;
  margin-top: 1px;
}

.weather-forecast b {
  color: var(--text);
  font-weight: 600;
}

/* Schedule grid */
.schedule {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 1px;
  background: var(--border);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}

.time-slot {
  display: grid;
  grid-template-columns: 80px 1fr;
  min-height: 56px;
  background: var(--surface);
  cursor: pointer;
  transition: background 0.12s;
  position: relative;
}

.time-slot:hover {
  background: var(--surface-hover);
}

.time-label {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--muted);
  background: var(--panel);
  border-right: 1px solid var(--border);
  user-select: none;
}

.task-area {
  display: flex;
  align-items: center;
  padding: 8px 16px;
  min-height: 56px;
  position: relative;
}

.task-card {
  flex: 1;
  padding: 8px 12px;
  border-radius: 6px;
  background: var(--surface-hover);
  font-size: 0.9rem;
  line-height: 1.4;
  border-left: 4px solid var(--card-blue);
  word-break: break-word;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.task-card.color-blue   { border-left-color: var(--card-blue);   background: color-mix(in srgb, var(--card-blue) 15%, transparent); }
.task-card.color-green  { border-left-color: var(--card-green);  background: color-mix(in srgb, var(--card-green) 15%, transparent); }
.task-card.color-orange { border-left-color: var(--card-orange); background: color-mix(in srgb, var(--card-orange) 12%, transparent); }
.task-card.color-red    { border-left-color: var(--card-red);    background: color-mix(in srgb, var(--card-red) 15%, transparent); }

.task-text {
  flex: 1;
}

.task-delete {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 1.1rem;
  padding: 2px 4px;
  border-radius: 4px;
  line-height: 1;
  flex-shrink: 0;
  transition: color 0.15s, background 0.15s;
}

.task-delete:hover {
  color: var(--card-red);
  background: color-mix(in srgb, var(--card-red) 15%, transparent);
}

.empty-slot {
  color: var(--muted);
  font-size: 0.85rem;
  font-style: italic;
}

/* Current time indicator */
.time-indicator {
  position: absolute;
  left: 80px;
  right: 0;
  height: 2px;
  background: #e74c3c;
  z-index: 10;
  pointer-events: none;
}

.time-indicator::before {
  content: "";
  position: absolute;
  left: -5px;
  top: -4px;
  width: 10px;
  height: 10px;
  background: #e74c3c;
  border-radius: 50%;
}

/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--modal-overlay);
  z-index: 100;
  align-items: center;
  justify-content: center;
  padding: 16px;
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: var(--surface);
  border-radius: 14px;
  padding: 28px;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  border: 1px solid var(--border);
  animation: modalIn 0.2s ease-out;
}

@keyframes modalIn {
  from { opacity: 0; transform: translateY(12px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal h2 {
  font-size: 1.15rem;
  margin-bottom: 20px;
  color: var(--accent);
}

.modal label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.modal input[type="text"] {
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 0.95rem;
  font-family: inherit;
  outline: none;
  transition: border-color 0.15s;
  margin-bottom: 18px;
  background: var(--input-bg);
  color: var(--text);
}

.modal input[type="text"]:focus {
  border-color: var(--accent);
}

.color-picker {
  display: flex;
  gap: 10px;
  margin-bottom: 24px;
}

.color-option {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 3px solid transparent;
  cursor: pointer;
  transition: border-color 0.15s, transform 0.15s;
}

.color-option:hover {
  transform: scale(1.12);
}

.color-option.selected {
  border-color: var(--text);
}

.color-option[data-color="blue"]   { background: var(--card-blue); }
.color-option[data-color="green"]  { background: var(--card-green); }
.color-option[data-color="orange"] { background: var(--card-orange); }
.color-option[data-color="red"]    { background: var(--card-red); }

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.modal-actions button {
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s;
}

.btn-save {
  background: var(--accent);
  color: #fff;
}

.btn-save:hover {
  background: var(--accent-hover);
}

.btn-cancel {
  background: var(--cancel-bg);
  color: var(--cancel-text);
}

.btn-cancel:hover {
  background: var(--surface-hover);
}

/* Drag and drop */
.task-card[draggable="true"] {
  cursor: grab;
}

.task-card[draggable="true"]:active {
  cursor: grabbing;
}

.time-slot.drag-over {
  background: var(--surface-hover);
  box-shadow: inset 0 0 0 2px var(--accent);
}

.time-slot.drag-source {
  opacity: 0.4;
}

/* Responsive */
@media (max-width: 480px) {
  .container {
    padding: 16px 8px;
  }

  .header h1 {
    font-size: 1.25rem;
  }

  .nav {
    gap: 6px;
  }

  .nav button {
    padding: 6px 10px;
    font-size: 0.8rem;
  }

  .date-display {
    font-size: 0.9rem;
    min-width: 140px;
  }

  .time-slot {
    grid-template-columns: 60px 1fr;
    min-height: 48px;
  }

  .time-label {
    font-size: 0.72rem;
  }

  .time-indicator {
    left: 60px;
  }

  .task-area {
    padding: 6px 10px;
  }

  .modal {
    padding: 20px;
  }
}
</style>
</head>
<body data-theme="galaxy">

<div class="container">
  <div class="header">
    <h1>Day Planner</h1>
    <div class="nav">
      <button class="arrow-btn" id="prevDay">&larr;</button>
      <button id="todayBtn">Today</button>
      <span class="date-display" id="dateDisplay"></span>
      <button class="arrow-btn" id="nextDay">&rarr;</button>
    </div>
  </div>

  <div class="info-bar" id="infoBar"></div>

  <div class="schedule" id="schedule"></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2 id="modalTitle">Add Task</h2>
    <label for="taskInput">Task</label>
    <input type="text" id="taskInput" placeholder="What are you planning?" maxlength="200" autocomplete="off">
    <label>Color</label>
    <div class="color-picker" id="colorPicker">
      <div class="color-option selected" data-color="blue"></div>
      <div class="color-option" data-color="green"></div>
      <div class="color-option" data-color="orange"></div>
      <div class="color-option" data-color="red"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="modalCancel">Cancel</button>
      <button class="btn-save" id="modalSave">Save</button>
    </div>
  </div>
</div>

<script>
(function() {
  // ── Theme system ──────────────────────────────────────────────
  const THEMES = {
    galaxy: {
      "--bg": "#0b0d1a",
      "--text": "#e0e0e0",
      "--accent": "#7b5ea7",
      "--accent-hover": "#9b7ec8",
      "--surface": "#12142a",
      "--surface-hover": "#1a1d3a",
      "--panel": "#090b18",
      "--border": "#252848",
      "--muted": "#6868a0",
      "--card-blue": "#4361ee",
      "--card-green": "#00b894",
      "--card-orange": "#fdcb6e",
      "--card-red": "#e17055",
      "--input-bg": "#080a15",
      "--modal-overlay": "rgba(0,0,0,0.7)",
      "--cancel-bg": "#252848",
      "--cancel-text": "#6868a0"
    },
    dune: {
      "--bg": "#1a1510",
      "--text": "#e8dcc8",
      "--accent": "#c8956c",
      "--accent-hover": "#d4a87a",
      "--surface": "#2a2318",
      "--surface-hover": "#3a3020",
      "--panel": "#151008",
      "--border": "#3d3425",
      "--muted": "#8a7a60",
      "--card-blue": "#c8956c",
      "--card-green": "#8fa858",
      "--card-orange": "#d4a040",
      "--card-red": "#c85a4a",
      "--input-bg": "#100c05",
      "--modal-overlay": "rgba(0,0,0,0.6)",
      "--cancel-bg": "#3d3425",
      "--cancel-text": "#8a7a60"
    },
    "blade-runner": {
      "--bg": "#0a0a12",
      "--text": "#c0d0d0",
      "--accent": "#e84393",
      "--accent-hover": "#fd79a8",
      "--surface": "#111118",
      "--surface-hover": "#1a1a28",
      "--panel": "#08080f",
      "--border": "#2a1a2e",
      "--muted": "#5a6868",
      "--card-blue": "#00cec9",
      "--card-green": "#00b894",
      "--card-orange": "#fdcb6e",
      "--card-red": "#e84393",
      "--input-bg": "#060610",
      "--modal-overlay": "rgba(0,0,0,0.75)",
      "--cancel-bg": "#2a1a2e",
      "--cancel-text": "#5a6868"
    },
    tron: {
      "--bg": "#050510",
      "--text": "#d0f0f0",
      "--accent": "#00ffff",
      "--accent-hover": "#66ffff",
      "--surface": "#0a0a1a",
      "--surface-hover": "#101025",
      "--panel": "#040410",
      "--border": "#0c3a3a",
      "--muted": "#4a8a8a",
      "--card-blue": "#00ffff",
      "--card-green": "#00e68a",
      "--card-orange": "#ffaa00",
      "--card-red": "#ff4444",
      "--input-bg": "#030308",
      "--modal-overlay": "rgba(0,0,0,0.8)",
      "--cancel-bg": "#0c3a3a",
      "--cancel-text": "#4a8a8a"
    }
  };

  function applyTheme(name) {
    const theme = THEMES[name];
    if (!theme) return;
    document.body.dataset.theme = name;
    for (const [prop, value] of Object.entries(theme)) {
      document.body.style.setProperty(prop, value);
    }
  }

  // Always apply Galaxy theme
  applyTheme("galaxy");

  // ── Day Planner app ──────────────────────────────────────────
  const START_HOUR = 6;
  const END_HOUR = 23;
  const STORAGE_PREFIX = "dayplanner_";

  let currentDate = new Date();
  let currentTasks = {};
  let editingHour = null;
  let selectedColor = "blue";
  let dragSourceHour = null;

  // Elements
  const scheduleEl = document.getElementById("schedule");
  const dateDisplayEl = document.getElementById("dateDisplay");
  const modalOverlay = document.getElementById("modalOverlay");
  const taskInput = document.getElementById("taskInput");
  const modalTitle = document.getElementById("modalTitle");
  const colorPicker = document.getElementById("colorPicker");

  // Helpers
  function dateKey(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  async function loadTasks(d) {
    try {
      const res = await fetch("/api/tasks/" + dateKey(d));
      if (!res.ok) return {};
      return await res.json();
    } catch {
      return {};
    }
  }

  async function saveTasks(d, tasks) {
    try {
      await fetch("/api/tasks/" + dateKey(d), {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(tasks)
      });
    } catch (e) {
      console.error("Failed to save tasks:", e);
    }
  }

  function formatHour(h) {
    if (h === 0) return "12 AM";
    if (h === 12) return "12 PM";
    if (h < 12) return h + " AM";
    return (h - 12) + " PM";
  }

  function formatDate(d) {
    const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
  }

  function isToday(d) {
    const now = new Date();
    return d.getFullYear() === now.getFullYear() &&
           d.getMonth() === now.getMonth() &&
           d.getDate() === now.getDate();
  }

  // Render
  async function render() {
    dateDisplayEl.textContent = formatDate(currentDate);
    currentTasks = await loadTasks(currentDate);

    scheduleEl.innerHTML = "";

    for (let h = START_HOUR; h <= END_HOUR; h++) {
      const slot = document.createElement("div");
      slot.className = "time-slot";
      slot.dataset.hour = h;

      const label = document.createElement("div");
      label.className = "time-label";
      label.textContent = formatHour(h);

      const area = document.createElement("div");
      area.className = "task-area";

      const task = currentTasks[h];
      if (task) {
        const card = document.createElement("div");
        card.className = `task-card color-${task.color || "blue"}`;
        card.draggable = true;

        card.addEventListener("dragstart", function(e) {
          dragSourceHour = h;
          slot.classList.add("drag-source");
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", String(h));
        });

        card.addEventListener("dragend", function() {
          dragSourceHour = null;
          scheduleEl.querySelectorAll(".drag-source, .drag-over").forEach(el => {
            el.classList.remove("drag-source", "drag-over");
          });
        });

        const text = document.createElement("span");
        text.className = "task-text";
        text.textContent = task.text;

        const del = document.createElement("button");
        del.className = "task-delete";
        del.innerHTML = "&times;";
        del.title = "Delete task";
        del.draggable = false;
        del.addEventListener("click", function(e) {
          e.stopPropagation();
          deleteTask(h);
        });

        card.appendChild(text);
        card.appendChild(del);
        area.appendChild(card);
      } else {
        const empty = document.createElement("span");
        empty.className = "empty-slot";
        empty.textContent = "Click to add...";
        area.appendChild(empty);
      }

      slot.addEventListener("dragover", function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        if (dragSourceHour !== null && dragSourceHour !== h) {
          slot.classList.add("drag-over");
        }
      });

      slot.addEventListener("dragleave", function() {
        slot.classList.remove("drag-over");
      });

      slot.addEventListener("drop", function(e) {
        e.preventDefault();
        slot.classList.remove("drag-over");
        const fromHour = parseInt(e.dataTransfer.getData("text/plain"), 10);
        if (isNaN(fromHour) || fromHour === h) return;
        moveTask(fromHour, h);
      });

      slot.addEventListener("click", function() {
        openModal(h);
      });

      slot.appendChild(label);
      slot.appendChild(area);
      scheduleEl.appendChild(slot);
    }

    updateTimeIndicator();
    if (cachedWeather) renderWeatherTile();
  }

  function updateTimeIndicator() {
    const existing = scheduleEl.querySelector(".time-indicator");
    if (existing) existing.remove();

    if (!isToday(currentDate)) return;

    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();

    if (currentHour < START_HOUR || currentHour > END_HOUR) return;

    const slotIndex = currentHour - START_HOUR;
    const slots = scheduleEl.querySelectorAll(".time-slot");
    if (!slots[slotIndex]) return;

    const slot = slots[slotIndex];
    const fraction = currentMinute / 60;
    const slotHeight = slot.offsetHeight;
    const offsetTop = slot.offsetTop + fraction * slotHeight;

    const indicator = document.createElement("div");
    indicator.className = "time-indicator";
    indicator.style.top = offsetTop + "px";
    scheduleEl.appendChild(indicator);
  }

  // Task operations
  async function moveTask(fromHour, toHour) {
    if (!currentTasks[fromHour]) return;
    const fromTask = currentTasks[fromHour];
    const toTask = currentTasks[toHour];
    if (toTask) {
      currentTasks[fromHour] = toTask;
      currentTasks[toHour] = fromTask;
    } else {
      delete currentTasks[fromHour];
      currentTasks[toHour] = fromTask;
    }
    await saveTasks(currentDate, currentTasks);
    await render();
  }

  async function deleteTask(hour) {
    delete currentTasks[hour];
    await saveTasks(currentDate, currentTasks);
    await render();
  }

  async function openModal(hour) {
    editingHour = hour;
    const existing = currentTasks[hour];

    if (existing) {
      modalTitle.textContent = "Edit Task — " + formatHour(hour);
      taskInput.value = existing.text;
      selectedColor = existing.color || "blue";
    } else {
      modalTitle.textContent = "Add Task — " + formatHour(hour);
      taskInput.value = "";
      selectedColor = "blue";
    }

    updateColorSelection();
    modalOverlay.classList.add("active");
    setTimeout(() => taskInput.focus(), 50);
  }

  function closeModal() {
    modalOverlay.classList.remove("active");
    editingHour = null;
  }

  async function saveTask() {
    const text = taskInput.value.trim();
    if (!text) {
      closeModal();
      return;
    }

    currentTasks[editingHour] = { text, color: selectedColor };
    await saveTasks(currentDate, currentTasks);
    closeModal();
    await render();
  }

  function updateColorSelection() {
    colorPicker.querySelectorAll(".color-option").forEach(el => {
      el.classList.toggle("selected", el.dataset.color === selectedColor);
    });
  }

  // Navigation
  function changeDate(offset) {
    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + offset);
    render();
  }

  function goToday() {
    currentDate = new Date();
    render();
  }

  // Event listeners
  document.getElementById("prevDay").addEventListener("click", () => changeDate(-1));
  document.getElementById("nextDay").addEventListener("click", () => changeDate(1));
  document.getElementById("todayBtn").addEventListener("click", goToday);
  document.getElementById("modalCancel").addEventListener("click", closeModal);
  document.getElementById("modalSave").addEventListener("click", saveTask);

  modalOverlay.addEventListener("click", function(e) {
    if (e.target === modalOverlay) closeModal();
  });

  document.addEventListener("keydown", function(e) {
    if (!modalOverlay.classList.contains("active")) return;
    if (e.key === "Escape") closeModal();
    if (e.key === "Enter") saveTask();
  });

  colorPicker.querySelectorAll(".color-option").forEach(el => {
    el.addEventListener("click", function(e) {
      e.stopPropagation();
      selectedColor = this.dataset.color;
      updateColorSelection();
    });
  });

  // Update time indicator every minute
  setInterval(updateTimeIndicator, 60000);

  // ── Market data & weather tiles ───────────────────────────────

  async function loadTickers() {
    const bar = document.getElementById("infoBar");
    try {
      const res = await fetch("/api/quotes");
      if (!res.ok) return;
      const quotes = await res.json();
      // Remove old ticker tiles only
      bar.querySelectorAll(".ticker-tile").forEach(function(el) { el.remove(); });
      // Insert before weather tile
      const weatherEl = bar.querySelector(".weather-tile");
      for (const [name, info] of Object.entries(quotes)) {
        const tile = document.createElement("div");
        tile.className = "ticker-tile";

        const label = document.createElement("span");
        label.className = "ticker-name";
        label.textContent = name;

        const pct = document.createElement("span");
        if (info.change_pct !== null) {
          const val = info.change_pct;
          const sign = val >= 0 ? "+" : "";
          pct.textContent = sign + val.toFixed(2) + "%";
          pct.className = "ticker-pct " + (val > 0 ? "positive" : val < 0 ? "negative" : "neutral");
        } else {
          pct.textContent = "\u2014";
          pct.className = "ticker-pct neutral";
        }

        tile.appendChild(label);
        tile.appendChild(pct);
        if (weatherEl) {
          bar.insertBefore(tile, weatherEl);
        } else {
          bar.appendChild(tile);
        }
      }
    } catch (e) {
      console.error("Failed to load tickers:", e);
    }
  }

  let cachedWeather = null;

  async function fetchWeather() {
    try {
      const res = await fetch("/api/weather");
      if (res.ok) cachedWeather = await res.json();
    } catch (e) {}
    renderWeatherTile();
  }

  function renderWeatherTile() {
    const bar = document.getElementById("infoBar");
    const old = bar.querySelector(".weather-tile");
    if (old) old.remove();

    const w = cachedWeather;
    if (!w) return;

    const wTile = document.createElement("div");
    wTile.className = "weather-tile";

    // Header: location name
    const header = document.createElement("div");
    header.className = "weather-header";
    const wLoc = document.createElement("span");
    wLoc.className = "weather-loc";
    wLoc.textContent = w.location || "";
    header.appendChild(wLoc);

    // Determine if viewing today or a forecast day
    const selectedKey = dateKey(currentDate);
    const todayKey = dateKey(new Date());
    const viewingToday = selectedKey === todayKey;
    const dayForecast = w.days ? w.days[selectedKey] : null;

    if (viewingToday && w.current) {
      // Current live conditions
      const c = w.current;

      const main = document.createElement("div");
      main.className = "weather-main";
      const wTemp = document.createElement("span");
      wTemp.className = "weather-temp";
      wTemp.textContent = c.temp_c !== null ? c.temp_c + "\u00B0C" : "\u2014";
      main.appendChild(wTemp);
      wTile.appendChild(header);
      wTile.appendChild(main);

      const desc = document.createElement("span");
      desc.className = "weather-desc";
      desc.textContent = c.desc || "";
      wTile.appendChild(desc);

      const details = document.createElement("div");
      details.className = "weather-details";
      if (dayForecast && dayForecast.high && dayForecast.low) {
        details.innerHTML += '<span class="weather-detail"><b>' + dayForecast.high + '\u00B0</b>/' + dayForecast.low + '\u00B0</span>';
      }
      if (c.rain_mm && c.rain_mm !== "0" && c.rain_mm !== "0.0") {
        details.innerHTML += '<span class="weather-detail">Rain <b>' + c.rain_mm + '</b>mm</span>';
      }
      if (c.wind_kmh) {
        let windTxt = 'Wind <b>' + c.wind_kmh + '</b>';
        if (c.gust_kmh) windTxt += '(G' + c.gust_kmh + ')';
        windTxt += 'km/h ' + (c.wind_dir || '');
        details.innerHTML += '<span class="weather-detail">' + windTxt + '</span>';
      }
      if (c.humidity) {
        details.innerHTML += '<span class="weather-detail">Hum <b>' + c.humidity + '%</b></span>';
      }
      wTile.appendChild(details);

      // Show next day forecast if available
      const tmrwKey = dateKey(new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + 1));
      const tmrw = w.days ? w.days[tmrwKey] : null;
      if (tmrw && tmrw.high && tmrw.low) {
        const forecast = document.createElement("div");
        forecast.className = "weather-forecast";
        let txt = "Tomorrow: <b>" + tmrw.high + "\u00B0</b>/" + tmrw.low + "\u00B0";
        if (tmrw.desc) txt += " \u2014 " + tmrw.desc;
        forecast.innerHTML = txt;
        wTile.appendChild(forecast);
      }

    } else if (dayForecast) {
      // Forecast day view
      wTile.appendChild(header);

      const main = document.createElement("div");
      main.className = "weather-main";
      const wTemp = document.createElement("span");
      wTemp.className = "weather-temp";
      wTemp.textContent = dayForecast.high + "\u00B0 / " + dayForecast.low + "\u00B0";
      main.appendChild(wTemp);
      const label = document.createElement("span");
      label.className = "weather-feels";
      label.textContent = "Forecast";
      main.appendChild(label);
      wTile.appendChild(main);

      const desc = document.createElement("span");
      desc.className = "weather-desc";
      desc.textContent = dayForecast.desc || "";
      wTile.appendChild(desc);

      const details = document.createElement("div");
      details.className = "weather-details";
      if (dayForecast.rain_mm && dayForecast.rain_mm !== "0" && dayForecast.rain_mm !== "0.0") {
        details.innerHTML += '<span class="weather-detail">Rain <b>' + dayForecast.rain_mm + '</b>mm</span>';
      }
      if (dayForecast.wind_kmh) {
        let windTxt = 'Wind <b>' + dayForecast.wind_kmh + '</b>';
        if (dayForecast.gust_kmh) windTxt += '(G' + dayForecast.gust_kmh + ')';
        windTxt += 'km/h ' + (dayForecast.wind_dir || '');
        details.innerHTML += '<span class="weather-detail">' + windTxt + '</span>';
      }
      if (dayForecast.humidity) {
        details.innerHTML += '<span class="weather-detail">Hum <b>' + dayForecast.humidity + '%</b></span>';
      }
      wTile.appendChild(details);

    } else {
      // Out of forecast range
      wTile.appendChild(header);
      const noData = document.createElement("span");
      noData.className = "weather-desc";
      noData.textContent = "No forecast available";
      wTile.appendChild(noData);
    }

    bar.appendChild(wTile);
  }

  async function loadWeather() {
    await fetchWeather();
  }

  async function loadInfoBar() {
    await Promise.all([loadTickers(), loadWeather()]);
  }

  loadInfoBar();
  setInterval(loadTickers, 5000);
  setInterval(loadWeather, 600000);

  // One-time migration: move localStorage data to server, then clean up
  async function migrateLocalStorage() {
    if (localStorage.getItem("dayplanner_migrated_to_server")) return;

    const keys = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k.startsWith(STORAGE_PREFIX) && !k.includes("migrated") && !k.includes("theme")) keys.push(k);
    }

    for (const k of keys) {
      const dateStr = k.replace(STORAGE_PREFIX, "");
      try {
        const tasks = JSON.parse(localStorage.getItem(k));
        if (tasks && Object.keys(tasks).length > 0) {
          await fetch("/api/tasks/" + dateStr, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(tasks)
          });
        }
      } catch {}
    }

    // Clean up localStorage
    keys.forEach(k => localStorage.removeItem(k));
    localStorage.removeItem("dayplanner_migrated_fwd1");
    localStorage.setItem("dayplanner_migrated_to_server", "1");
  }

  // Init
  migrateLocalStorage().then(() => render());
})();
</script>
</body>
</html>
